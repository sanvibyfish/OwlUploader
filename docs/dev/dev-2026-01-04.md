# 开发记录 - 2026-01-04

## 优化目标

1. 完成国际化（i18n）剩余硬编码字符串
2. 修复菜单栏重复 View 菜单问题
3. 重新设计 WelcomeView 欢迎页面
4. 重新设计 Settings 设置页面为 macOS 原生风格

---

## 第一阶段 - 国际化补充

### 1. 新增本地化字符串

**修改 `AppStrings.swift`：**

新增以下字符串：
- `L.Help.back` - 返回
- `L.Help.forward` - 前进
- `L.Help.moreOptions` - 更多选项
- `L.Help.closeEsc` - 关闭 (Esc)
- `L.Files.Menu.filterSection` - 筛选
- `L.Files.Menu.sortSection` - 排序
- `L.Move.Message.moveFailed` - 移动失败
- `L.Move.Message.noMoveNeeded` - 无需移动
- `L.Move.Message.alreadyAtDestination` - 文件已在目标位置
- `L.Error.Service.r2NotInitialized` - R2服务未初始化

**更新的文件：**
- `FileListView.swift` - 替换硬编码字符串
- `FilePreviewView.swift` - 替换硬编码字符串
- `UploadQueueManager.swift` - 替换硬编码字符串
- `MoveQueueManager.swift` - 替换硬编码字符串

---

## 第二阶段 - 菜单修复

### 2. 修复重复 View 菜单问题

**问题：**
- 菜单栏出现两个 "View" 菜单
- 原因：`CommandMenu(L.Commands.view)` 创建了新菜单，而非添加到已有菜单

**解决方案：**

**修改 `AppCommands.swift`：**
```swift
// 修改前
CommandMenu(L.Commands.view) { ... }

// 修改后
CommandGroup(after: .sidebar) { ... }
```

**效果：**
- ✅ 视图模式选项正确添加到系统 View 菜单
- ✅ 无重复菜单

---

## 第三阶段 - WelcomeView 重新设计

### 3. 专业级欢迎页面

**设计目标：**
- 参考 Finder/Transmit 风格的快速上手引导
- 清晰的品牌展示
- 状态响应式 CTA 按钮

**新建 `Views/WelcomeView.swift`：**

**主要组件：**
1. **应用图标区域** (`appIconView`)
   - 使用真实应用图标 `NSApplication.shared.applicationIconImage`
   - 渐变圆形背景装饰
   - 96x96pt 图标尺寸

2. **标题区域** (`titleSection`)
   - 应用名称（32pt, semibold）
   - 副标题说明

3. **状态卡片** (`statusCard`)
   - 显示连接状态和账户名
   - 使用 `R2AccountManager.shared.currentAccount`
   - 三种状态：未连接 / 已连接无 bucket / 已连接有 bucket

4. **CTA 按钮** (`ctaButton`)
   - 状态响应式：配置账户 / 选择存储桶 / 开始管理文件
   - 使用 `@Environment(\.openSettings)` 打开设置

5. **底部提示** (`hintText`)
   - 快捷键提示

**修改 `ContentView.swift`：**
- 移除旧的内联 WelcomeView 实现
- 使用新的独立组件
- 移除 `onOpenSettings` 回调（WelcomeView 直接使用 Environment）

---

## 第四阶段 - Settings 设置页面重新设计

### 4. macOS 原生 TabView 风格

**最终方案：** 使用原生 `TabView`（用户调整）

**修改 `AccountSettingsView.swift`：**

```swift
var body: some View {
    TabView {
        AccountsTabView(...)
            .tabItem {
                Label(L.Account.Settings.sectionTitle, systemImage: "person.crop.circle")
            }

        GeneralTabView(...)
            .tabItem {
                Label(L.Settings.General.title, systemImage: "gearshape")
            }

        AboutTabView()
            .tabItem {
                Label(L.About.title, systemImage: "info.circle")
            }
    }
    .frame(width: 500, height: 400)
}
```

### 5. 使用原生 Settings Scene

**修改 `OwlUploaderApp.swift`：**
```swift
var body: some Scene {
    WindowGroup {
        ContentView()
    }
    // ...

    // macOS 原生设置窗口
    Settings {
        AccountSettingsView()
            .environmentObject(R2Service.shared)
            .environmentObject(R2AccountManager.shared)
            .environmentObject(MessageManager())
    }
}
```

**效果：**
- ✅ 标准窗口控件（红黄绿按钮）
- ✅ `Cmd + ,` 快捷键自动支持
- ✅ 独立窗口，可自由移动

### 6. 移除重复 Settings 菜单项

**问题：**
- `Settings` scene 自动添加菜单项
- `AppCommands` 手动添加导致重复

**解决方案：**

**修改 `AppCommands.swift`：**
- 移除 `CommandGroup(replacing: .appSettings)` 代码块
- 移除相关的 `SettingsActions` 使用

### 7. 使用 SettingsLink 打开设置

**修改 `WelcomeView.swift`：**
```swift
@Environment(\.openSettings) private var openSettings

private func handleCTAAction() {
    if !r2Service.isConnected {
        openSettings()  // 直接使用 Environment action
    }
    // ...
}
```

**修改 `ContentView.swift`：**
- 移除 `@Environment(\.openSettings)` 和相关代码
- WelcomeView 自行处理打开设置

### 8. 优化账户列表显示

**修改 `AccountsTabView`：**
- 简化账户行布局
- 显示账户名、Access Key ID
- 连接状态用绿色勾选图标表示
- 编辑/删除按钮

### 9. 优化通用设置标签页

**修改 `GeneralTabView`：**
- 使用原生 `Stepper` 替代 TextField + Stepper 组合
- 数值显示在左侧标签旁
- 更符合 macOS 原生风格

```swift
Stepper(value: $concurrentUploads, in: 1...50, step: 1) {
    HStack {
        Text(L.Settings.Upload.concurrentUploads)
        Spacer()
        Text("\(Int(concurrentUploads))")
            .foregroundColor(.secondary)
            .monospacedDigit()
    }
}
```

### 10. About 标签页使用真实应用图标

**修改 `AboutTabView`：**
- 居中布局
- 真实应用图标（96x96pt）
- 动态版本号（从 Bundle 获取）
- 版权信息

### 11. 新增本地化字符串

**修改 `AppStrings.swift`：**
- `L.Settings.General.title` - 通用
- `L.About.copyright` - 版权声明

---

## 代码统计

### 新增文件
- `OwlUploader/Views/WelcomeView.swift` - 约 220 行

### 修改文件
- `OwlUploader/AccountSettingsView.swift` - 重构为 TabView 风格
- `OwlUploader/ContentView.swift` - 简化设置相关代码
- `OwlUploader/AppCommands.swift` - 移除重复设置菜单
- `OwlUploader/OwlUploaderApp.swift` - 添加 Settings scene
- `OwlUploader/Localization/AppStrings.swift` - 新增字符串

### 删除代码
- 移除旧的内联 WelcomeView 和 FeatureRow
- 移除手动 Settings 菜单代码
- 移除 SettingsActions 相关代码

---

## 最终效果

### WelcomeView
```
┌────────────────────────────────────────┐
│                                        │
│            [应用图标]                  │
│                                        │
│          OwlUploader                   │
│     Cloudflare R2 文件管理             │
│                                        │
│    ┌──────────────────────────┐       │
│    │ ● 已连接 - accountName   │       │
│    └──────────────────────────┘       │
│                                        │
│        [ 配置账户 / CTA ]              │
│                                        │
│      Cmd+, 打开设置                    │
└────────────────────────────────────────┘
```

### Settings 窗口
```
┌─────────────────────────────────────────┐
│ ● ○ ○                                   │
├─────────────────────────────────────────┤
│  [Account] [General] [About]            │  ← TabView
├─────────────────────────────────────────┤
│                                         │
│  账户列表 / 通用设置 / 关于信息          │
│                                         │
└─────────────────────────────────────────┘
```

---

## 测试要点

### WelcomeView
- [ ] 应用图标正确显示
- [ ] 未连接状态显示"未连接"
- [ ] 已连接状态显示账户名
- [ ] CTA 按钮根据状态变化
- [ ] 点击 CTA 正确执行操作

### Settings
- [ ] `Cmd + ,` 打开设置窗口
- [ ] 三个标签页切换正常
- [ ] 账户列表显示正确
- [ ] 添加/编辑/删除账户功能正常
- [ ] Stepper 控件工作正常
- [ ] About 显示真实图标和版本号
- [ ] 关闭窗口（红色按钮）正常

---

## 相关文件

- 欢迎视图: `OwlUploader/Views/WelcomeView.swift`
- 设置视图: `OwlUploader/AccountSettingsView.swift`
- 应用入口: `OwlUploader/OwlUploaderApp.swift`
- 本地化: `OwlUploader/Localization/AppStrings.swift`
