# 05. æ–‡ä»¶ä¸‹è½½ã€åˆ é™¤ä¸é‡å‘½å (File Download, Delete & Rename)

## åŠŸèƒ½æ¦‚è¿°

æ–‡ä»¶ä¸‹è½½ã€åˆ é™¤ä¸é‡å‘½åæ¨¡å—æä¾›ä» R2 å­˜å‚¨ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ã€åˆ é™¤è¿œç¨‹æ–‡ä»¶å’Œé‡å‘½åæ–‡ä»¶/æ–‡ä»¶å¤¹çš„åŠŸèƒ½ã€‚æ”¯æŒå•æ–‡ä»¶å’Œæ‰¹é‡æ“ä½œã€‚

## æ ¸å¿ƒç»„ä»¶

| æ–‡ä»¶ | èŒè´£ |
|------|-----|
| `FileListView.swift` | ä¸‹è½½/åˆ é™¤/é‡å‘½åæ“ä½œå…¥å£ã€æ‰¹é‡æ“ä½œ |
| `FilePreviewView.swift` | æ–‡ä»¶é¢„è§ˆè§†å›¾ |
| `FileGridItemView.swift` | ç½‘æ ¼è§†å›¾æ–‡ä»¶é¡¹æ“ä½œ |
| `FileTableView.swift` | è¡¨æ ¼è§†å›¾æ–‡ä»¶é¡¹æ“ä½œ |
| `FinderToolbar.swift` | æ‰¹é‡æ“ä½œå·¥å…·æ  |
| `SelectionManager.swift` | å¤šé€‰çŠ¶æ€ç®¡ç† |
| `RenameSheet.swift` | é‡å‘½åå¯¹è¯æ¡†ç»„ä»¶ |
| `R2Service.swift` | ä¸‹è½½/åˆ é™¤/é‡å‘½å API |
| `DownloadQueueManager.swift` | ä¸‹è½½é˜Ÿåˆ—ç®¡ç†ã€è¿›åº¦è¿½è¸ªã€ä»»åŠ¡å»é‡ |

## åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°

- **æ–‡ä»¶é¢„è§ˆ**: åŒå‡»æ–‡ä»¶æ‰“å¼€é¢„è§ˆçª—å£
- **å•æ–‡ä»¶ä¸‹è½½**: å³é”®èœå•æˆ–æ‚¬åœæŒ‰é’®ä¸‹è½½
- **æ‰¹é‡ä¸‹è½½**: é€‰æ‹©å¤šä¸ªæ–‡ä»¶åæ‰¹é‡ä¸‹è½½åˆ°æŒ‡å®šç›®å½•
- **æ–‡ä»¶å¤¹ä¸‹è½½**: å³é”®èœå•ä¸‹è½½æ•´ä¸ªæ–‡ä»¶å¤¹ï¼Œä¿æŒç›®å½•ç»“æ„
- **ä¸‹è½½ä½ç½®é€‰æ‹©**: é€šè¿‡ç³»ç»Ÿå¯¹è¯æ¡†é€‰æ‹©ä¿å­˜ä½ç½®
- **å•æ–‡ä»¶åˆ é™¤**: åˆ é™¤å•ä¸ªæ–‡ä»¶
- **æ‰¹é‡åˆ é™¤**: é€‰æ‹©å¤šä¸ªæ–‡ä»¶åæ‰¹é‡åˆ é™¤ï¼ˆä½¿ç”¨æ‰¹é‡ API ä¼˜åŒ–ï¼‰
- **åˆ é™¤ç¡®è®¤**: åˆ é™¤å‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- **æ–‡ä»¶é‡å‘½å**: å³é”®èœå•é‡å‘½åæ–‡ä»¶
- **æ–‡ä»¶å¤¹é‡å‘½å**: å³é”®èœå•é‡å‘½åæ–‡ä»¶å¤¹
- **æ“ä½œåé¦ˆ**: æˆåŠŸ/å¤±è´¥çŠ¶æ€æç¤º
- **å¤šé€‰æ”¯æŒ**: Cmd+Click æ·»åŠ é€‰æ‹©ï¼ŒShift+Click èŒƒå›´é€‰æ‹©
- **ä»»åŠ¡å–æ¶ˆ**: æ”¯æŒå–æ¶ˆè¿›è¡Œä¸­çš„ä¸‹è½½ä»»åŠ¡
- **ä»»åŠ¡å»é‡**: è‡ªåŠ¨è·³è¿‡å·²åœ¨é˜Ÿåˆ—ä¸­çš„æ´»è·ƒä»»åŠ¡
- **è‡ªåŠ¨åˆ›å»ºç›®å½•**: ä¸‹è½½æ—¶è‡ªåŠ¨åˆ›å»ºæ‰€éœ€çš„æœ¬åœ°ç›®å½•ç»“æ„

## å·²çŸ¥é—®é¢˜ / æ”¹è¿›æ–¹å‘

- **ä¸‹è½½å†…å­˜å ç”¨**ï¼šå½“å‰ `downloadObject` ä¼šå°†å¯¹è±¡ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜å†å†™å…¥ç£ç›˜ï¼Œå¤§æ–‡ä»¶å¯èƒ½å¯¼è‡´å†…å­˜é£™å‡ã€‚åç»­éœ€è¦æ”¹ä¸ºæµå¼è¯»å–/å†™å…¥ï¼Œé€å—è½ç›˜ã€‚
- âœ… **ç›®å½•å ä½ç¬¦å†²çª**ï¼šå·²ä¿®å¤ã€‚ä¸‹è½½ R2 æ–‡ä»¶å¤¹æ—¶ï¼Œä¸å¸¦å°¾æ–œæ çš„ç›®å½•å ä½ç¬¦å¯¹è±¡ä¼šè¢«è‡ªåŠ¨è¿‡æ»¤ï¼Œé¿å…ä¸å®é™…ç›®å½•è·¯å¾„å†²çªï¼ˆv1.0.1+ï¼‰ã€‚

## æ–‡ä»¶é¢„è§ˆ

### è§¦å‘æ–¹å¼

åŒå‡»æ–‡ä»¶æˆ–é€šè¿‡å³é”®èœå•é€‰æ‹©ã€Œé¢„è§ˆã€æ‰“å¼€é¢„è§ˆçª—å£ã€‚

### æ”¯æŒçš„æ–‡ä»¶ç±»å‹

| ç±»å‹ | æ‰©å±•å | é¢„è§ˆæ–¹å¼ |
|------|--------|----------|
| **å›¾ç‰‡** | jpg, png, gif, webp, bmp, ico, svg | å›¾ç‰‡è§†å›¾ï¼ˆè‡ªé€‚åº”ç¼©æ”¾ï¼‰ |
| **è§†é¢‘** | mp4, mov, avi, mkv, webm | AVPlayer æ’­æ”¾å™¨ |
| **éŸ³é¢‘** | mp3, wav, flac, aac, ogg, m4a | AVPlayer æ’­æ”¾å™¨ |
| **PDF** | pdf | PDFKit æ¸²æŸ“ |
| **æ–‡æœ¬** | txt, md, json, xml, html, css, js, ts, swift ç­‰ | ç­‰å®½å­—ä½“æ–‡æœ¬æ˜¾ç¤º |

### é¢„è§ˆç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å›¾æ ‡] photo.jpg  2.3 MB Â· JPEG â”‚  [â—€] [â–¶]  â”‚ [â¬‡] [ğŸ”—] [ğŸ—‘] [âœ•] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚                                                             â”‚
â”‚                     [å›¾ç‰‡/è§†é¢‘/æ–‡æ¡£å†…å®¹]                      â”‚
â”‚                                                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å…·æ åŠŸèƒ½

| æŒ‰é’® | åŠŸèƒ½ |
|:----:|------|
| `â—€` `â–¶` | åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªæ–‡ä»¶ |
| `â¬‡` | ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ° |
| `ğŸ”—` | å¤åˆ¶å…¬å¼€é“¾æ¥åˆ°å‰ªè´´æ¿ |
| `ğŸ—‘` | åˆ é™¤æ–‡ä»¶ |
| `âœ•` | å…³é—­é¢„è§ˆ |

### é”®ç›˜å¿«æ·é”®

| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| `â†` | ä¸Šä¸€ä¸ªæ–‡ä»¶ |
| `â†’` | ä¸‹ä¸€ä¸ªæ–‡ä»¶ |
| `Esc` | å…³é—­é¢„è§ˆ |

## æ–‡ä»¶ä¸‹è½½

### å•æ–‡ä»¶ä¸‹è½½

1. å³é”®ç‚¹å‡»æ–‡ä»¶æˆ–æ‚¬åœæ˜¾ç¤ºä¸‹è½½æŒ‰é’®
2. é€‰æ‹©æœ¬åœ°ä¿å­˜ä½ç½®
3. å¼€å§‹ä¸‹è½½
4. å®Œæˆåæ˜¾ç¤ºæˆåŠŸæç¤º

### æ‰¹é‡ä¸‹è½½

1. ä½¿ç”¨ Cmd+Click æˆ– Shift+Click é€‰æ‹©å¤šä¸ªæ–‡ä»¶
2. å·¥å…·æ æ˜¾ç¤ºé€‰ä¸­æ•°é‡å’Œæ‰¹é‡æ“ä½œæŒ‰é’®
3. ç‚¹å‡» **Download** æŒ‰é’®
4. é€‰æ‹©ä¿å­˜ç›®å½•
5. æ‰€æœ‰æ–‡ä»¶ä¸‹è½½åˆ°æŒ‡å®šç›®å½•

### æ–‡ä»¶å¤¹ä¸‹è½½

1. å³é”®ç‚¹å‡»æ–‡ä»¶å¤¹ï¼Œé€‰æ‹©ã€Œä¸‹è½½ã€
2. é€‰æ‹©æœ¬åœ°ä¿å­˜ä½ç½®
3. ç³»ç»Ÿæ‰«ææ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶
4. **è‡ªåŠ¨è¿‡æ»¤ç›®å½•å ä½ç¬¦å¯¹è±¡**ï¼ˆé˜²æ­¢ä¸å®é™…ç›®å½•å†²çªï¼‰
5. è‡ªåŠ¨åˆ›å»ºæœ¬åœ°ç›®å½•ç»“æ„
6. æ‰¹é‡ä¸‹è½½æ‰€æœ‰æ–‡ä»¶åˆ°å¯¹åº”å­ç›®å½•

**ç›®å½•ç»“æ„ä¿æŒ**:

```
R2 å­˜å‚¨æ¡¶:                          æœ¬åœ°ä¸‹è½½ç›®å½•:
screenshots/                        ~/Downloads/screenshots/
â”œâ”€â”€ blog/                    â†’      â”œâ”€â”€ blog/
â”‚   â”œâ”€â”€ 2025/                       â”‚   â”œâ”€â”€ 2025/
â”‚   â”‚   â”œâ”€â”€ cover.jpg               â”‚   â”‚   â”œâ”€â”€ cover.jpg
â”‚   â”‚   â””â”€â”€ thumb.png               â”‚   â”‚   â””â”€â”€ thumb.png
â”‚   â””â”€â”€ assets/                     â”‚   â””â”€â”€ assets/
â”‚       â””â”€â”€ logo.svg                â”‚       â””â”€â”€ logo.svg
```

**ç›®å½•å ä½ç¬¦è¿‡æ»¤æœºåˆ¶**:

æŸäº› S3/R2 å®¢æˆ·ç«¯å·¥å…·ä¼šåˆ›å»ºä¸å¸¦å°¾æ–œæ çš„ç›®å½•å ä½ç¬¦å¯¹è±¡ï¼ˆå¦‚ `t1`ã€`t1/t2`ï¼‰ï¼Œè¿™äº›å¯¹è±¡çš„ key æ°å¥½ç­‰äºå…¶ä»–æ–‡ä»¶è·¯å¾„ä¸­çš„ç›®å½•å‰ç¼€ã€‚ä¸‹è½½æ—¶å¦‚æœä¸è¿‡æ»¤ï¼Œä¼šä¸å®é™…ç›®å½•è·¯å¾„å†²çªå¯¼è‡´å¤±è´¥ã€‚

ç³»ç»Ÿé€šè¿‡**ä¸¤å±‚é˜²å¾¡æœºåˆ¶**ç¡®ä¿ä¸‹è½½æˆåŠŸï¼š

1. **åˆ—è¡¨é˜¶æ®µè¿‡æ»¤**ï¼ˆ`listAllFilesInFolder`ï¼‰
   - æ‰«æå®Œæ–‡ä»¶å¤¹åï¼Œä»æ‰€æœ‰æ–‡ä»¶çš„ relativePath ä¸­æå–ç›®å½•å‰ç¼€
   - è¿‡æ»¤æ‰ relativePath æ°å¥½ç­‰äºæŸä¸ªç›®å½•å‰ç¼€çš„æ¡ç›®ï¼ˆå³ç›®å½•å ä½ç¬¦ï¼‰
   - ä»…ä¿ç•™çœŸæ­£çš„æ–‡ä»¶å¯¹è±¡

2. **ä¸‹è½½é˜¶æ®µé˜²å¾¡æ€§æ£€æŸ¥**ï¼ˆ`DownloadQueueManager`ï¼‰
   - ä¸‹è½½å‰æ£€æŸ¥ localURL æ˜¯å¦å·²ä½œä¸ºç›®å½•å­˜åœ¨
   - å¦‚æœå·²å­˜åœ¨åŒåç›®å½•ï¼Œè·³è¿‡ä¸‹è½½ï¼ˆé¿å…æ–‡ä»¶-ç›®å½•å†²çªï¼‰

**ç¤ºä¾‹**:

```
R2 å¯¹è±¡åˆ—è¡¨ï¼ˆå«å ä½ç¬¦ï¼‰:          è¿‡æ»¤åï¼ˆä»…ä¿ç•™æ–‡ä»¶ï¼‰:
vowels/t1 (0 bytes)  â† å ä½ç¬¦      vowels/t1/t2/carrier.mp3
vowels/t1/t2 (0 bytes) â† å ä½ç¬¦
vowels/t1/t2/carrier.mp3 (1024 bytes)
```

### ä¸‹è½½ API

```swift
// æ™®é€šä¸‹è½½ï¼ˆå°æ–‡ä»¶ï¼‰
func downloadObject(
    bucket: String,
    key: String,
    to localURL: URL
) async throws

// åˆ†æ®µä¸‹è½½ï¼ˆå¤§æ–‡ä»¶ï¼Œ> 10MBï¼‰
func downloadObjectChunked(
    bucket: String,
    key: String,
    to localURL: URL,
    fileSize: Int64,
    progress: @escaping (Int64, Int64) -> Void
) async throws

// åˆ—å‡ºæ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶ï¼ˆè‡ªåŠ¨è¿‡æ»¤ç›®å½•å ä½ç¬¦ï¼‰
func listAllFilesInFolder(
    bucket: String,
    folderPrefix: String
) async throws -> [(key: String, size: Int64, relativePath: String)]

// è¿‡æ»¤ç›®å½•å ä½ç¬¦å¯¹è±¡ï¼ˆé™æ€å·¥å…·æ–¹æ³•ï¼‰
static func filterDirectoryPlaceholders(
    from files: [(key: String, size: Int64, relativePath: String)]
) -> [(key: String, size: Int64, relativePath: String)]
```

### ç›®å½•è‡ªåŠ¨åˆ›å»º

ä¸‹è½½æ–‡ä»¶æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ‰€éœ€çš„çˆ¶ç›®å½•ï¼š

```swift
// ä¸‹è½½å‰è‡ªåŠ¨åˆ›å»ºç›®å½•
let parentDirectory = localURL.deletingLastPathComponent()
try FileManager.default.createDirectory(
    at: parentDirectory,
    withIntermediateDirectories: true,
    attributes: nil
)
```

è¿™ç¡®ä¿äº†ï¼š
- æ–‡ä»¶å¤¹ä¸‹è½½æ—¶ï¼Œå­ç›®å½•ç»“æ„ä¼šè¢«æ­£ç¡®åˆ›å»º
- ä¸ä¼šå› ä¸ºç›®å½•ä¸å­˜åœ¨è€Œå¯¼è‡´ä¸‹è½½å¤±è´¥

## æ–‡ä»¶åˆ é™¤

### å•æ–‡ä»¶åˆ é™¤

```mermaid
flowchart TD
    A[é€‰æ‹©æ–‡ä»¶] --> B[ç‚¹å‡»åˆ é™¤]
    B --> C[æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†]
    C --> D{ç”¨æˆ·ç¡®è®¤?}
    D -->|å–æ¶ˆ| E[å…³é—­å¯¹è¯æ¡†]
    D -->|ç¡®è®¤| F[æ‰§è¡Œåˆ é™¤]
    F --> G{åˆ é™¤ç»“æœ}
    G -->|æˆåŠŸ| H[åˆ·æ–°åˆ—è¡¨]
    G -->|å¤±è´¥| I[æ˜¾ç¤ºé”™è¯¯]
    H --> J[æ˜¾ç¤ºæˆåŠŸæç¤º]
```

### æ‰¹é‡åˆ é™¤

1. é€‰æ‹©å¤šä¸ªæ–‡ä»¶
2. å·¥å…·æ æ˜¾ç¤ºæ‰¹é‡æ“ä½œåŒº
3. ç‚¹å‡» **Delete** æŒ‰é’®
4. ç¡®è®¤å¯¹è¯æ¡†æ˜¾ç¤º "Delete N Files?"
5. ç¡®è®¤åä¾æ¬¡åˆ é™¤æ‰€æœ‰é€‰ä¸­æ–‡ä»¶
6. æ˜¾ç¤ºåˆ é™¤ç»“æœç»Ÿè®¡

### ç¡®è®¤å¯¹è¯æ¡†

**å•æ–‡ä»¶åˆ é™¤ï¼š**
```
Complete Deletion
Are you sure you want to delete 'example.txt'?
[Cancel] [Delete]
```

**æ‰¹é‡åˆ é™¤ï¼š**
```
Delete 5 Files?
This action cannot be undone.
[Cancel] [Delete]
```

### åˆ é™¤ API

```swift
// åˆ é™¤å•ä¸ªå¯¹è±¡
func deleteObject(bucket: String, key: String) async throws

// æ‰¹é‡åˆ é™¤å¯¹è±¡ï¼ˆæœ€å¤š 1000 ä¸ªï¼Œæ¨èç”¨äºå¤šæ–‡ä»¶åˆ é™¤ï¼‰
func deleteObjects(bucket: String, keys: [String]) async throws -> [String]

// åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆé€’å½’åˆ é™¤æ‰€æœ‰å†…å®¹ï¼Œå†…éƒ¨ä½¿ç”¨æ‰¹é‡ APIï¼‰
func deleteFolder(bucket: String, folderKey: String) async throws -> (deleted: Int, failed: [String])
```

### æ‰¹é‡åˆ é™¤ä¼˜åŒ–

å¤šé€‰åˆ é™¤ä½¿ç”¨ S3 `DeleteObjects` æ‰¹é‡ APIï¼Œä¸€æ¬¡è¯·æ±‚æœ€å¤šåˆ é™¤ 1000 ä¸ªæ–‡ä»¶ï¼š

```swift
// ä¼˜åŒ–å‰ï¼šN ä¸ªæ–‡ä»¶ = N æ¬¡ API è°ƒç”¨ï¼ˆæ…¢ï¼‰
for file in files {
    try await r2Service.deleteObject(bucket: bucketName, key: file.key)
}

// ä¼˜åŒ–åï¼šN ä¸ªæ–‡ä»¶ = 1 æ¬¡ API è°ƒç”¨ï¼ˆå¿«ï¼‰
let fileKeys = files.map { $0.key }
let failedKeys = try await r2Service.deleteObjects(bucket: bucketName, keys: fileKeys)
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æ–‡ä»¶æ•°é‡ | ä¸²è¡Œåˆ é™¤ | æ‰¹é‡åˆ é™¤ |
|---------|---------|---------|
| 10 ä¸ªæ–‡ä»¶ | ~2-3 ç§’ | ~0.3 ç§’ |
| 100 ä¸ªæ–‡ä»¶ | ~20-30 ç§’ | ~0.5 ç§’ |
| 1000 ä¸ªæ–‡ä»¶ | ~3-5 åˆ†é’Ÿ | ~1 ç§’ |

## æ–‡ä»¶å¤¹åˆ é™¤

### æŠ€æœ¯è¯´æ˜

R2/S3 ä½¿ç”¨æ‰å¹³çš„é”®å€¼å­˜å‚¨ç»“æ„ï¼Œ"æ–‡ä»¶å¤¹"å®é™…ä¸Šæ˜¯ä»¥ `/` ç»“å°¾çš„ç©ºå¯¹è±¡ï¼ˆæ–‡ä»¶å¤¹æ ‡è®°ï¼‰åŠ ä¸Šå…±äº«ç›¸åŒå‰ç¼€çš„ä¸€ç»„å¯¹è±¡ã€‚

### åˆ é™¤æµç¨‹

```mermaid
flowchart TD
    A[é€‰æ‹©æ–‡ä»¶å¤¹] --> B[ç‚¹å‡»åˆ é™¤]
    B --> C[æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†]
    C --> D{ç”¨æˆ·ç¡®è®¤?}
    D -->|å–æ¶ˆ| E[å…³é—­å¯¹è¯æ¡†]
    D -->|ç¡®è®¤| F[åˆ—å‡ºæ‰€æœ‰å­å¯¹è±¡]
    F --> G[æ”¶é›†æ‰€æœ‰å¯¹è±¡ key]
    G --> H[æ·»åŠ æ–‡ä»¶å¤¹æ ‡è®°å¯¹è±¡]
    H --> I[æ‰¹é‡åˆ é™¤æ‰€æœ‰å¯¹è±¡]
    I --> J{åˆ é™¤ç»“æœ}
    J -->|æˆåŠŸ| K[åˆ·æ–°æ–‡ä»¶åˆ—è¡¨]
    J -->|å¤±è´¥| L[æ˜¾ç¤ºé”™è¯¯]
    K --> M[æ˜¾ç¤ºæˆåŠŸæç¤º]
```

### åˆ é™¤å†…å®¹

æ–‡ä»¶å¤¹åˆ é™¤ä¼šç§»é™¤ï¼š
1. **æ‰€æœ‰å­æ–‡ä»¶**: æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æ–‡ä»¶
2. **æ‰€æœ‰å­æ–‡ä»¶å¤¹**: é€’å½’åˆ é™¤åµŒå¥—çš„æ–‡ä»¶å¤¹åŠå…¶å†…å®¹
3. **æ–‡ä»¶å¤¹æ ‡è®°å¯¹è±¡**: ä»¥ `/` ç»“å°¾çš„ç©ºå¯¹è±¡ï¼ˆè¡¨ç¤ºæ–‡ä»¶å¤¹æœ¬èº«ï¼‰

### ç¡®è®¤å¯¹è¯æ¡†

**æ–‡ä»¶å¤¹åˆ é™¤ï¼š**
```
ç¡®è®¤åˆ é™¤
ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ 'documents' å—ï¼Ÿ
æ­¤æ–‡ä»¶å¤¹åŒ…å« 15 ä¸ªæ–‡ä»¶ï¼Œåˆ é™¤åæ— æ³•æ¢å¤ã€‚
[å–æ¶ˆ] [åˆ é™¤]
```

## å¤šé€‰æ“ä½œ

### é€‰æ‹©æ¨¡å¼

| æ“ä½œ | å¿«æ·é”® | è¯´æ˜ |
|------|--------|------|
| å•é€‰ | ç‚¹å‡» | æ¸…é™¤å…¶ä»–é€‰æ‹©ï¼Œåªé€‰ä¸­å½“å‰ |
| æ·»åŠ é€‰æ‹© | Cmd + ç‚¹å‡» | å°†æ–‡ä»¶æ·»åŠ /ç§»é™¤é€‰æ‹© |
| èŒƒå›´é€‰æ‹© | Shift + ç‚¹å‡» | é€‰ä¸­ä»ä¸Šæ¬¡é€‰æ‹©åˆ°å½“å‰çš„æ‰€æœ‰æ–‡ä»¶ |
| å…¨é€‰ | Cmd + A | é€‰ä¸­å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶ |
| å–æ¶ˆé€‰æ‹© | Esc æˆ–ç‚¹å‡»ç©ºç™½ | æ¸…é™¤æ‰€æœ‰é€‰æ‹© |

### æ‰¹é‡æ“ä½œå·¥å…·æ 

å½“æœ‰æ–‡ä»¶è¢«é€‰ä¸­æ—¶ï¼Œå·¥å…·æ ä¸­é—´åŒºåŸŸä¼šæ˜¾ç¤ºæ‰¹é‡æ“ä½œåŒºï¼š

```
[â† â†»] â”€â”€â”€â”€â”€â”€â”€ [3 items selected | Download | Delete] â”€â”€â”€â”€â”€â”€â”€ [+ â†‘ â‰¡ âŠ â˜°]
```

- **é€‰ä¸­è®¡æ•°**: æ˜¾ç¤º "N items selected"
- **Download**: æ‰¹é‡ä¸‹è½½æŒ‰é’®
- **Delete**: æ‰¹é‡åˆ é™¤æŒ‰é’®ï¼ˆçº¢è‰²è­¦ç¤ºï¼‰

## é”™è¯¯å¤„ç†

| é”™è¯¯ç±»å‹ | æè¿° | å¤„ç†æ–¹å¼ |
|---------|------|---------|
| `downloadFailed` | ä¸‹è½½è¯·æ±‚å¤±è´¥ | æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ |
| `deleteFileFailed` | åˆ é™¤è¯·æ±‚å¤±è´¥ | æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ |
| `networkError` | ç½‘ç»œè¿æ¥é”™è¯¯ | å»ºè®®é‡è¯• |
| `permissionDenied` | æƒé™ä¸è¶³ | æ£€æŸ¥ API æƒé™ |

### æ‰¹é‡æ“ä½œç»“æœ

æ‰¹é‡æ“ä½œå®Œæˆåæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼š

- **å…¨éƒ¨æˆåŠŸ**: "Deleted Successfully - N files deleted"
- **éƒ¨åˆ†å¤±è´¥**: "Partially Deleted - M succeeded, N failed"

## æ–‡ä»¶é‡å‘½å

### è§¦å‘æ–¹å¼

å³é”®ç‚¹å‡»æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼Œé€‰æ‹©ã€Œé‡å‘½åã€èœå•é¡¹ã€‚

### é‡å‘½åå¯¹è¯æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Rename                      â”‚
â”‚                                          â”‚
â”‚  New Name:                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ document.pdf                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  Names cannot contain: \ / : * ? " < > |â”‚
â”‚  âœ“ Valid name                           â”‚
â”‚                                          â”‚
â”‚  [Cancel]                    [Rename]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éªŒè¯è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| éç©º | åç§°ä¸èƒ½ä¸ºç©ºæˆ–ä»…åŒ…å«ç©ºæ ¼ |
| éæ³•å­—ç¬¦ | ä¸èƒ½åŒ…å« `\ / : * ? " < > \|` |
| åç§°å˜åŒ– | æ–°åç§°å¿…é¡»ä¸åŸåç§°ä¸åŒ |

### éªŒè¯çŠ¶æ€æç¤º

| çŠ¶æ€ | é¢œè‰² | è¯´æ˜ |
|------|------|------|
| âœ“ Valid name | ç»¿è‰² | åç§°æœ‰æ•ˆä¸”ä¸åŸåä¸åŒ |
| Name unchanged | æ©™è‰² | åç§°ä¸åŸåç›¸åŒ |
| Invalid name | çº¢è‰² | åŒ…å«éæ³•å­—ç¬¦ |

### é”®ç›˜å¿«æ·é”®

| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| `Enter` | ç¡®è®¤é‡å‘½å |
| `Esc` | å–æ¶ˆæ“ä½œ |

### é‡å‘½å API

```swift
func renameObject(
    bucket: String,
    oldKey: String,
    newKey: String
) async throws
```

**å®ç°åŸç†**: R2/S3 ä¸æ”¯æŒåŸç”Ÿé‡å‘½åï¼Œé€šè¿‡ Copy + Delete å®ç°ï¼š
1. å¤åˆ¶å¯¹è±¡åˆ°æ–° key
2. åˆ é™¤åŸå¯¹è±¡

### Key æ„å»ºé€»è¾‘

é‡å‘½åæ—¶éœ€è¦ä¿ç•™åŸæœ‰çš„ç›®å½•è·¯å¾„ï¼š

**æ–‡ä»¶é‡å‘½å**:
```swift
// åŸ key: "documents/reports/old.pdf"
// æ–°åç§°: "new.pdf"
// æ–° key: "documents/reports/new.pdf"
```

**æ–‡ä»¶å¤¹é‡å‘½å**:
```swift
// åŸ key: "projects/2024/reports/"
// æ–°åç§°: "documents"
// æ–° key: "projects/2024/documents/"
```

æ³¨æ„ï¼šæ–‡ä»¶å¤¹ key ä»¥ `/` ç»“å°¾ï¼Œå¤„ç†æ—¶éœ€è¦å…ˆå»é™¤å†æ·»åŠ ã€‚

### é”™è¯¯å¤„ç†

| é”™è¯¯ç±»å‹ | æè¿° | å¤„ç†æ–¹å¼ |
|---------|------|---------|
| `renameFailed` | é‡å‘½åè¯·æ±‚å¤±è´¥ | æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ |
| `copyFailed` | å¤åˆ¶å¯¹è±¡å¤±è´¥ | æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ |
| `networkError` | ç½‘ç»œè¿æ¥é”™è¯¯ | å»ºè®®é‡è¯• |

## æµ‹è¯•è¦†ç›–

### ç›®å½•å ä½ç¬¦è¿‡æ»¤æµ‹è¯• (`R2ServiceTests.swift`)

| æµ‹è¯•ç”¨ä¾‹ | æè¿° |
|---------|------|
| `testFilterDirectoryPlaceholders_removesPlaceholdersWithoutTrailingSlash` | éªŒè¯è¿‡æ»¤æ‰ä¸å¸¦å°¾æ–œæ çš„ç›®å½•å ä½ç¬¦ï¼ˆå¦‚ `t1`ã€`t1/t2`ï¼‰ |
| `testFilterDirectoryPlaceholders_preservesLegitimateFiles` | éªŒè¯ä¿ç•™æ‰€æœ‰çœŸå®æ–‡ä»¶ |
| `testFilterDirectoryPlaceholders_emptyList` | éªŒè¯ç©ºåˆ—è¡¨å¤„ç† |
| `testFilterDirectoryPlaceholders_singleFile` | éªŒè¯å•æ–‡ä»¶åœºæ™¯ |
| `testFilterDirectoryPlaceholders_deepNestedPlaceholderChain` | éªŒè¯æ·±å±‚åµŒå¥—çš„å ä½ç¬¦é“¾ |
| `testFilterDirectoryPlaceholders_similarNameNotFalselyFiltered` | éªŒè¯ç›¸ä¼¼åç§°æ–‡ä»¶ä¸ä¼šè¢«è¯¯è¿‡æ»¤ï¼ˆå¦‚ `t1.txt` vs `t1`ï¼‰ |
| `testFilterDirectoryPlaceholders_multipleSubdirectories` | éªŒè¯å¤šä¸ªå­ç›®å½•å„è‡ªçš„å ä½ç¬¦å¤„ç† |

### ä¸‹è½½ç›®å½•åˆ›å»ºæµ‹è¯• (`R2ServiceTests.swift`)

| æµ‹è¯•ç”¨ä¾‹ | æè¿° |
|---------|------|
| `testDownloadDirectoryCreation_parentDirectoryCreatedWhenNeeded` | éªŒè¯ä¸‹è½½å‰è‡ªåŠ¨åˆ›å»ºåµŒå¥—ç›®å½• |
| `testDownloadDirectoryCreation_existingDirectoryNotAffected` | éªŒè¯å·²å­˜åœ¨ç›®å½•ä¸å—å½±å“ |
| `testDownloadDirectoryCreation_multiLevelNestedPath` | éªŒè¯å¤šå±‚åµŒå¥—è·¯å¾„åˆ›å»º |
| `testDownloadDirectoryCreation_fileCanBeCreatedAfterDirectorySetup` | éªŒè¯ç›®å½•åˆ›å»ºåæ–‡ä»¶èƒ½æ­£ç¡®å†™å…¥ |

**è¿è¡Œæµ‹è¯•**:

```bash
# è¿è¡Œæ‰€æœ‰ R2Service ç›¸å…³æµ‹è¯•
xcodebuild test -scheme OwlUploader -destination 'platform=macOS' \
  -only-testing:OwlUploaderTests/R2ServiceTests

# è¿è¡Œç›®å½•å ä½ç¬¦è¿‡æ»¤æµ‹è¯•
xcodebuild test -scheme OwlUploader -destination 'platform=macOS' \
  -only-testing:OwlUploaderTests/R2ServiceTests/testFilterDirectoryPlaceholders_removesPlaceholdersWithoutTrailingSlash
```

## ç›¸å…³é“¾æ¥

- [æ–‡ä»¶å¯¼èˆª](./03-file-navigation.md)
- [æ–‡ä»¶ä¸Šä¼ ](./04-file-upload.md)
- [Finder UI è®¾è®¡è§„èŒƒ](./09-finder-ui-design.md)
